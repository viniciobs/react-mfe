parameters:
- name: mfeName
  type: string
- name: mfePath
  type: string
- name: deployPath
  type: string
- name: storageAccountName
  type: string
- name: buildFolder
  type: string
  default: 'dist'

steps:
  - checkout: self

  - task: NodeTool@0
    displayName: 'Install Node.js'
    inputs:
      versionSpec: '23.x'

  - powershell: |
      corepack enable 
      corepack prepare pnpm@latest --activate
      pnpm --version
    displayName: 'Enable pnpm'

  - powershell: |
      Write-Host "Installing dependencies for ${{parameters.mfeName}}..."
      pnpm install:${{parameters.mfeName}}
    displayName: 'Install dependencies'

  - powershell: |
      Write-Host "Building ${{parameters.mfeName}}..."
      pnpm run build:${{parameters.mfeName}}
    displayName: 'Build MFE'
  
  - task: AzureCLI@2
    displayName: 'Upload MFE with versioning + CDN purge'
    inputs:
      azureSubscription: sc-react-sandbox
      scriptType: ps
      scriptLocation: inlineScript
      inlineScript: |
        $version = Get-Date -Format "yyyyMMdd-HHmmss"
        $sourcePath = "${{ parameters.mfePath }}/${{ parameters.buildFolder }}"
        $releasePath = "remotes/${{ parameters.mfeName }}/releases/$version"

        Write-Host "Deploying version: $version"
        Write-Host "Source: $sourcePath"
        Write-Host "Destination: $releasePath"

        az storage blob sync `
          --account-name ${{ parameters.storageAccountName }} `
          --container-name '$web' `
          --source "$sourcePath" `
          --destination-path "$releasePath" `
          --auth-mode login `
          --delete-destination false

        az storage blob sync `
          --account-name ${{ parameters.storageAccountName }} `
          --container-name '$web' `
          --source "$sourcePath" `
          --destination-path "remotes/${{ parameters.mfeName }}/current" `
          --auth-mode login `
          --delete-destination true

        az cdn endpoint purge `
          --resource-group RG_NAME `
          --profile-name CDN_PROFILE `
          --name CDN_ENDPOINT `
          --content-paths "/remotes/${{ parameters.mfeName }}/*"

        Write-Host "Deployment completed for ${{ parameters.mfeName }}"
